<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Comparateur Paie — Silae ↔ Wagyz (Python backend)</title>

<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#1f2328; }
  body { margin:0; background:#f6f7fb; }
  .container { max-width: 1120px; margin: 28px auto; background:#fff; padding: 20px; border-radius: 12px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
  h1 { font-size:1.5rem; margin: 0 0 8px; }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap: 12px; }
  label { font-weight:600; display:block; margin: 4px 0; }
  input[type=file], input[type=number] { width:100%; padding:10px; border:1px solid #d9d9e3; border-radius:8px; background:#fafafa; }
  button { background:#0068ff; color:#fff; border:0; border-radius:8px; padding:10px 14px; font-size:.95rem; cursor:pointer; }
  button:disabled { background:#a6c4ff; cursor:not-allowed; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px; }
  .status { margin-top:12px; padding:10px; border-radius:8px; background:#eef5ff; color:#003d99; display:none; white-space:pre-line; }
  .error { margin-top:12px; padding:10px; border-radius:8px; background:#ffecec; color:#b00; display:none; white-space:pre-wrap; }
  table { width:100%; border-collapse: collapse; margin-top:16px; }
  th, td { border-bottom:1px solid #eee; padding:8px; vertical-align:top; text-align:left; }
  th { background:#fafafa; }
  .badge-ok { background:#e6ffed; color:#03630b; border:1px solid #9fe6a0; border-radius:8px; padding:3px 8px; }
  .badge-mid { background:#fff7e6; color:#7a4d00; border:1px solid #ffd699; border-radius:8px; padding:3px 8px; }
  .badge-err { background:#ffefef; color:#93000a; border:1px solid #ffc2c2; border-radius:8px; padding:3px 8px; }
  .btn-ghost { background:#f2f4f7; color:#111; border:1px solid #e5e7eb; }
  .detail-box { background:#fafcff; border-left:3px solid #0068ff; padding:10px 12px; border-radius:8px; white-space:pre-wrap; }
  .small { font-size:.9rem; color:#777; }
  .debug { margin-top:14px; display:none; }
  .debug pre { background:#f8f9fb; border:1px solid #e7e9ef; padding:10px; border-radius:8px; max-height:220px; overflow:auto; }
</style>
</head>

<body>
<div class="container">
  <h1>Contrôle Niveau 1 — Silae ↔ Wagyz</h1>
  <p class="small">
    Extraction PDF fiable via <b>Python</b>.  
    Scoring, tolérance, appariement et analyse <b>inchangés</b>.
  </p>

  <div class="grid">
    <div>
      <label>PDF Silae</label>
      <input id="fileSilae" type="file" accept="application/pdf">
    </div>
    <div>
      <label>PDF Wagyz</label>
      <input id="fileWagyz" type="file" accept="application/pdf">
    </div>
  </div>

  <div class="row">
    <label for="tol">Tolérance (€)</label>
    <input id="tol" type="number" step="0.01" value="0.05" style="max-width:140px">
    <button id="runBtn">Lancer le contrôle</button>
    <button id="exportBtn" disabled>Exporter CSV</button>
    <button id="dbgBtn" class="btn-ghost">Afficher / Masquer Debug</button>
  </div>

  <div id="status" class="status"></div>
  <div id="error" class="error"></div>

  <div id="debug" class="debug">
    <h3>Debug — texte extrait (20 premières lignes)</h3>
    <div class="grid">
      <div>
        <h4>Silae</h4>
        <pre id="dbgSilae"></pre>
      </div>
      <div>
        <h4>Wagyz</h4>
        <pre id="dbgWagyz"></pre>
      </div>
    </div>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Salarié</th>
        <th>Clé</th>
        <th>Appariement</th>
        <th>Score</th>
        <th>Statut</th>
        <th>Actions</th>
        <th>Écarts</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/* ================= Utils UI ================= */
const statusEl = document.getElementById('status');
const errorEl  = document.getElementById('error');
const tbody    = document.querySelector('#tbl tbody');
const dbgEl    = document.getElementById('debug');
const dbgS     = document.getElementById('dbgSilae');
const dbgW     = document.getElementById('dbgWagyz');

const fmtE = v => (v==null || isNaN(v)) ? '—' : v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2});
const setStatus = m => { statusEl.textContent=m; statusEl.style.display='block'; errorEl.style.display='none'; };
const setError  = m => { errorEl.textContent=m; errorEl.style.display='block'; statusEl.style.display='none'; };
const clearBars = ()=>{ statusEl.style.display='none'; errorEl.style.display='none'; };

/* ================= API ================= */
async function callCompareAPI(fileSilae, fileWagyz){
  const form = new FormData();
  form.append("silae", fileSilae);
  form.append("wagyz", fileWagyz);

  const res = await fetch("/api/compare", { method:"POST", body: form });
  if (!res.ok) throw new Error("Erreur API " + res.status);
  return await res.json();
}

/* ================= Scoring (INCHANGÉ) ================= */
function scoreLevel1(mS, mW, tol){
  const flags=[]; let sc=0;
  const eq=(a,b)=> a!=null && b!=null && Math.abs(a-b)<=tol;

  const fields=[
    ['salaire_brut','Brut',10],
    ['net_imposable','Net imposable',10],
    ['net_a_payer','Net à payer',10],
    ['net_social','Net social',10],
    ['total_cotisations_salariales','Cot. salariales',10],
    ['total_charges_patronales','Cot. patronales',10],
    ['cout_total_employeur','Coût total',10],
  ];

  for(const [k,l,p] of fields){
    if(eq(mS[k],mW[k])) sc+=p;
    else flags.push(`${l} différent (S:${mS[k]} / W:${mW[k]})`);
  }

  const cong=[['n1','acquis'],['n1','pris'],['n1','solde'],['n','acquis'],['n','pris'],['n','solde']];
  for(const [b,k] of cong){
    if(eq(mS.conges?.[b]?.[k],mW.conges?.[b]?.[k])) sc+=12/6;
    else flags.push(`Congés ${b.toUpperCase()} ${k} différent`);
  }

  return { score: Math.round(sc*100)/100, flags };
}

/* ================= Rendu ================= */
function renderRows(rows, tol){
  tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const name=[r.s?.nom,r.s?.prenom].filter(Boolean).join(' ')
      || [r.w?.nom,r.w?.prenom].filter(Boolean).join(' ') || '—';
    const badge=r.score>=95?'badge-ok':(r.score>=70?'badge-mid':'badge-err');
    const label=r.score>=95?'OK':(r.score>=70?'À investiguer':'Non conforme');

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${name}</td>
      <td>${r.key||'—'}</td>
      <td>${r.matched_by}</td>
      <td>${r.score.toFixed(2)}</td>
      <td><span class="${badge}">${label}</span></td>
      <td><button class="btn-ghost" data-i="${i}">+ Détail</button></td>
      <td>${(r.flags||[]).join('; ')}</td>`;
    tbody.appendChild(tr);

    const trd=document.createElement('tr');
    trd.style.display='none';
    trd.innerHTML=`<td colspan="7"><div class="detail-box" id="d${i}"></div></td>`;
    tbody.appendChild(trd);

    tr.querySelector('button').onclick=()=>{
      trd.style.display = trd.style.display==='none'?'':'none';
      document.getElementById(`d${i}`).textContent =
        JSON.stringify({Silae:r.mS, Wagyz:r.mW}, null, 2);
    };
  });
}

/* ================= Main ================= */
let lastRows=[], currentTol=0.05;

document.getElementById('dbgBtn').onclick=()=>{
  dbgEl.style.display = dbgEl.style.display==='block'?'none':'block';
};

document.getElementById('runBtn').onclick=async ()=>{
  try{
    clearBars();
    currentTol=Math.max(0,parseFloat(document.getElementById('tol').value)||0.05);

    const fS=document.getElementById('fileSilae').files[0];
    const fW=document.getElementById('fileWagyz').files[0];
    if(!fS||!fW){ setError("Sélectionne les deux PDFs."); return; }

    setStatus("Extraction et comparaison via Python…");
    const data=await callCompareAPI(fS,fW);

    if(data.rows?.[0]?.dbg){
      dbgS.textContent=data.rows[0].dbg.s_first_lines||'';
      dbgW.textContent=data.rows[0].dbg.w_first_lines||'';
    }

    const rows=[];
    for(const r of data.rows){
      const {score,flags}=scoreLevel1(r.mS||{}, r.mW||{}, currentTol);
      rows.push({...r, score, flags});
    }

    lastRows=rows.slice();
    renderRows(rows,currentTol);
    document.getElementById('exportBtn').disabled=!rows.length;
    clearBars();
  }catch(e){
    console.error(e);
    setError(e.message||e);
  }
};

document.getElementById('exportBtn').onclick=()=>{
  if(!lastRows.length) return;
  const L=[['Salarié','Clé','Appariement','Score','Statut','Flags'].join(',')];
  lastRows.forEach(r=>{
    const n=[r.s?.nom,r.s?.prenom].filter(Boolean).join(' ')
      || [r.w?.nom,r.w?.prenom].filter(Boolean).join(' ');
    const st=r.score>=95?'OK':(r.score>=70?'À investiguer':'Non conforme');
    L.push(`"${n}","${r.key}","${r.matched_by}",${r.score},"${st}","${(r.flags||[]).join('|')}"`);
  });
  const b=new Blob([L.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(b);
  a.download='controle_paie.csv';
  a.click();
};
</script>
</body>
</html>
